{% extends "layout.jinja2" %}

{#
<!-- {% block pagestyles %}
  {% assets "home_less_bundle" %}
    <link href="{{ ASSET_URL }}" rel="stylesheet" type="text/css">
  {% endassets %}
{% endblock %} -->

#}{% set df = df|default([]) -%}


{% block content %}

  {% set active_category = "curve" -%}
  {% set active_page = "curve_meta" -%}
  {% set sub_active_page = 'compage_gauges' -%}
  {% include "navigation.jinja2" %}
    <div class="row">
      <h1>{{ title }}</h1>
    </div>
    {% if body %}
    <div class="row">
      <h2>{{ body }}</h2>
    </div>  
    {% endif %}
    <div class="row">
    <div class="col-lg">

        <div class="card bg-warning text-info mb-3" >
          <div class="card-body">

          <form method="POST" action="{{ url_for('curve_meta_bp.compare_gauges') }}">
            {{ form.csrf_token }}
            <h3 class="card-title text-dark">Select Parameters: </h3>
            <table class="table table-hover">
            <tbody>
                <tr>
                <th scope="row"> {{ form.target_gauges.label }}</th>
                <td >{{ form.target_gauges(placeholder='0x90efd41e75360ffc7fd1d3c5fc0e4f43e8bcd9bc', cols="42", rows="5") }}</td>
                </tr>
                {% if form.target_gauges.errors %}
                  {% for error in form.target_gauges.errors %}
                  <tr class="errors">
                  <th scope="row text-danger"> Error ^ </th>
                  <td>{{ error }}</td>
                  </tr>
                  {% endfor %}
                {% endif %}
                <tr>
                <th scope="row">{{ form.compare_back.label }}</th>
                <td>{{ form.compare_back(placeholder=16) }}</td>
                </tr>
                {% if form.compare_back.errors %}
                  {% for error in form.compare_back.errors %}
                  <tr class="errors">
                  <th scope="row text-danger"> Error ^ </th>
                  <td>{{ error }}</td>
                  </tr>
                  {% endfor %}
                {% endif %}
            </tbody>
            </table>

            <div class="submit-button" >
                {{ form.submit }}
            </div>

        </form>
        </div>
      </div>


    </div>
    </div>
    <div class="row">
    <div class="col-lg">

        <div class="card bg-outline-warning mb-3" >
            <div class="card-header">Reference Table</div>
                <div class="card-body">
                <div id="reference_table" class="reference_table"></div>
            </div>
        </div>
    </div>
    </div>

{% if df|length > 0 %}

    {# {% with gauge_info=local_df_curve_gauge_registry.iloc[0] %}
        {% include 'gauge_widget.jinja2' %} 
    {% endwith %} #}

    <div class="row">
    <div class = "col-md" >

        <div class="card text-white bg-primary mb-3" >
          <div class="card-header">Balances (USD) Stacked </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              {# <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> #}
              <div id="chart1" class="chart1" style="width:97%"></div>
          </div>
        </div>
    </div>
    <div class = "col-md" >

        <div class="card border-info mb-3" >
          <div class="card-header">Balances (USD) </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              {# <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> #}
              <div id="chart2" class="chart2" style="width:97%"></div>
          </div>
        </div>
    </div>
    </div>

    <div class="row">
    <div class = "col-md" >
        <div class="card text-white bg-primary mb-3" >
          <div class="card-header">Issuance Value (USD) Stacked </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              {# <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> #}
              <div id="chart3" class="chart3" style="width:97%"></div>
          </div>
        </div>
    </div>
    <div class = "col-md" >

        <div class="card border-info mb-3" >
          <div class="card-header">Issuance Value (USD) </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              {# <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> #}
              <div id="chart4" class="chart4" style="width:97%"></div>
          </div>
        </div>
    </div>
    </div>

    <div class="row">
    <div class = "col-md" >
        <div class="card text-white bg-primary mb-3" >
          <div class="card-header">Vote Percent (veCRV) </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              {# <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> #}
              <div id="chart5" class="chart5" style="width:97%"></div>
          </div>
        </div>
    </div>
    <div class = "col-md" >

        <div class="card border-info mb-3" >
          <div class="card-header">Yield Rates </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              {# <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> #}
              <div id="chart6" class="chart6" style="width:97%"></div>
          </div>
        </div>
    </div>
    </div>
    {% if df.total_bounty_value.unique()|length == 0 %}
    <div class="row">
    <div class = "col-md" >
        <div class="card text-white bg-primary mb-3" >
          <div class="card-header">Bounty Value (USD) Stacked </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              {# <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> #}
              <div id="chart7" class="chart7" style="width:97%"></div>
          </div>
        </div>
    </div>
    <div class = "col-md" >

        <div class="card border-info mb-3" >
          <div class="card-header">Bounty Value (USD) Stacked </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              {# <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p> #}
              <div id="chart8" class="chart8" style="width:97%"></div>
          </div>
        </div>
    </div>
    </div>
    {% endif %}

    <div class="row">
    <div class = "col-md" >

        <div class="card text-white bg-secondary mb-3" >
          <div class="card-header">Balance (USD) / Votes (veCRV) </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              <div id="chart9" class="chart9" style="width:97%"></div>
              <p class="card-text">Values > 100 are filtered out for visibility</p>

          </div>
        </div>
    </div>
    </div>

    <div class="row">
    <div class = "col-md" >

        <div class="card text-white bg-info mb-3" >
          <div class="card-header">Meta </div>
          <div class="card-body">
              {# <h4 class="card-title">??}}</h4> #}
              <div id="chart10" class="chart10" style="width:97%"></div>
              {# <p class="card-text">Values > 100 are filtered out for visibility</p> #}

          </div>
        </div>
    </div>
    </div>



    <div class="row">
        <h4 class="text-primary">Top {{top_x}} Contributing Factors</h4>
        <div id="head_table"></div>
    </div>




<script type='text/javascript'>
      new gridjs.Grid({
        columns: [
            { id: 'checkpoint_id', name: 'Checkpoint ID' },
            { id: 'checkpoint_timestamp', name: 'Checkpoint Timestamp'},

            { id: 'gauge_name', name: 'Gauge Name'},

            { id: 'gauge_addr', name: 'Gauge Addr',
                formatter: (_, row) => gridjs.html(
                  `${row.cells[3].data.toString()}`
                )
            },

            { id: 'avg_crv_price', name: 'Avg CRV Price',
              {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'issuance_distributed', name: 'Issuance Recieved',
              {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'issuance_value', name: 'Issuance Value',
                formatter: (_, row) =>  `${row.cells[6].data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`,
                {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'yield_rate_adj', name: 'Yield Rate Adj',
                formatter: (_, row) =>  `${row.cells[7].data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`,
                {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'total_vote_percent', name: 'veCRV Vote Percent',
                formatter: (_, row) =>  `${row.cells[8].data.toString().replace(/\B(?=(\d{4})+(?!\d))/g, ",")}`,
                {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'total_balance_usd', name: 'TVL USD',
                formatter: (_, row) =>  `${row.cells[9].data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`,
                {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'total_bounty_value', name: 'Bounty (USD)',
                formatter: (_, row) =>  `${row.cells[10].data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`,
                {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'votium_round', name: 'Votium Round',
                formatter: (_, row) =>  `${row.cells[11].data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`,
                {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'liquidity_usd_over_votes', name: 'Balance / Votes',
                formatter: (_, row) =>  `${row.cells[11].data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`,
                {% include 'utility_sort_float.jinja2' %} 
            },
            { id: 'tradable_assets', name: 'Assets'},


        ],
        data: [
          {% for index, row in df.iterrows() %}
            {
              'checkpoint_id': '{{ row['checkpoint_id'] }}',
              'checkpoint_timestamp': '{{ row['checkpoint_timestamp']  }}',
              'gauge_name': '{{ row['gauge_name'] }}',
              'gauge_addr':  `<a href={{ url_for('curve_meta_bp.contributing_factors_show', gauge_addr = row['gauge_addr']) }}>
                            {{row['gauge_addr']}}</a>`,
              'avg_crv_price': '{{ row['avg_crv_price']| round(4) }}',
              'issuance_distributed': '{{ row['issuance_distributed']| round(2) }}',
              'issuance_value': '{{ row['issuance_value']|round(2)  }}',
              'yield_rate_adj': '{{ row['yield_rate_adj']|round(2) }}',
              'total_vote_percent': '{{ row['total_vote_percent']|round(4) }}',
              'total_balance_usd': '{{ row['total_balance_usd']|round(2) }}',
              'total_bounty_value': '{{ row['total_bounty_value']|round(2) }}',
              'votium_round': '{{ row['votium_round']|round() }}',
              'liquidity_usd_over_votes': '{{ row['liquidity_usd_over_votes']|round() }}',
              'tradable_assets': '{{ row['tradable_assets']|join(", ") }}',



            },
          {% endfor %}
        ],
        {% include 'table_format_helper.jinja2' %}

      }).render(document.getElementById('head_table'));
</script>




{% for graph_json in graph_list %}
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <script type='text/javascript'>
      var graphs = {{graph_json | safe}};
      Plotly.plot("chart{{loop.index}}",graphs,{});
    </script> 
{% endfor %}


{% endif %}
<script type='text/javascript'>
      new gridjs.Grid({
        columns: [
            { id: 'gauge_name', name: 'Gauge Name' },
            { id: 'gauge_symbol', name: 'Gauge Symbol',},
            { id: 'gauge_addr', name: 'Gauge Address'},
            { id: 'pool_symbol', name: 'Pool Symbol'},
            { id: 'pool_addr', name: 'Pool Address'},
            { id: 'vote_timestamp', name: 'Vote Timestamp'},

        ],
        data: [
          {% for index, row in df_approved_gauges.iterrows() %}
            {
              'gauge_name': '{{ row['gauge_name'] }}',
              'gauge_symbol': '{{ row['gauge_symbol']  }}',
              'gauge_addr': '{{ row['gauge_addr'] }}',
              'pool_symbol': '{{ row['pool_symbol'] }}',
              'pool_addr': '{{ row['pool_addr'] }}',
              'vote_timestamp': '{{ row['vote_timestamp'] }}',

            },
          {% endfor %}
        ],
        {% with max_size = 5 %}
        {% with table_type = 'info' %}

          {% include 'table_format_helper.jinja2' %}
        {% endwith %}
        {% endwith %}

      }).render(document.getElementById('reference_table'));
</script>
{% endblock %}

